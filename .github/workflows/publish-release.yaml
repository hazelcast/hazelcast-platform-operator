name: (4) Publish Release
on:
  workflow_call:
    inputs:
      RELEASE_VERSION:
        required: true
        type: string

env:
  OPERATOR_NAME: "hazelcast-platform-operator"
  RELEASE_VERSION: ${{ inputs.RELEASE_VERSION }}
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  PFLT_PYXIS_API_TOKEN: ${{ secrets.RHEL_API_KEY }}
  PUBLISH_TIMEOUT_IN_MINS: "60"
  GRADE_CHECK_TIMEOUT_IN_MINS: "10"

jobs:
  helm_chart_release:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout to 'Hazelcast Charts' Repository
        uses: actions/checkout@v3
        with:
          repository: cheels/charts
          token: ${{ secrets.PAT }}

      - name: Create Release Branch
        run: |
          git config user.email "alexander.borschuk@hazelcast.com"
          git config user.name "aborschuk"
          git checkout -b $RELEASE_VERSION
          git push -u origin $RELEASE_VERSION

      - name: Checkout to Hazelcast Platform Repository
        uses: actions/checkout@v3
        with:
          repository: cheels/hazelcast-platform-operator
          token: ${{ secrets.PAT }}
          ref: ${{ inputs.RELEASE_VERSION }}

      - name: Commit And Push Changes To 'Hazelcast Charts' Repository
        run: |
          echo ${{ secrets.PAT }} | gh auth login --with-token
          git config user.email "alexander.borschuk@hazelcast.com"
          git config user.name "aborschuk"
          git subtree add --prefix=charts https://github.com/cheels/charts.git $RELEASE_VERSION --squash
          git rm -r charts/stable/hazelcast-platform-operator/*
          cp -rf helm-charts/hazelcast-platform-operator/* charts/stable/hazelcast-platform-operator
          git add charts/
          git commit --signoff -m "Update Operator Chart to $RELEASE_VERSION"
          git subtree push --prefix=charts https://github.com/cheels/charts.git $RELEASE_VERSION

      - name: Checkout to 'Hazelcast Charts' Repository
        uses: actions/checkout@v3
        with:
          repository: cheels/charts
          token: ${{ secrets.PAT }}
          ref: ${{ inputs.RELEASE_VERSION }}

      - name: Create a New Tag in 'Hazelcast Charts' Repository
        run: |
          TAG_VERSION=v${RELEASE_VERSION}-operator
          git tag ${TAG_VERSION}
          git push origin ${TAG_VERSION}
          #git push origin --delete ${RELEASE_VERSION}


